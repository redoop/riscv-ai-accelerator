# 逻辑综合后网表仿真指南

## 📋 概述

本文档说明如何对逻辑综合后的网表进行仿真验证，这是流片前的关键验证步骤。

## 🎯 目的

逻辑综合后网表仿真的目的：

1. **功能验证**: 确认综合后网表功能与 RTL 一致
2. **时序验证**: 验证时序约束是否满足
3. **门级验证**: 检查门级实现的正确性
4. **问题发现**: 及早发现综合引入的问题

## 📁 文件结构

已创建的文件：

```
chisel/synthesis/
├── README.md                      # 详细使用说明
├── Makefile                       # Make 构建文件
├── run_post_syn_sim.py           # Python 自动化脚本
├── testbench/
│   ├── post_syn_tb.sv            # 基本测试平台
│   ├── advanced_post_syn_tb.sv   # 高级测试平台
│   ├── test_utils.sv             # 测试工具库
│   └── filelist.f                # 文件列表
├── netlist/                       # 网表目录（需要生成）
├── sim/                           # 仿真输出
└── waves/                         # 波形文件
```

## 🚀 使用方法

### 方法 1: Python 脚本（推荐）

```bash
cd chisel/synthesis

# 运行完整仿真
python run_post_syn_sim.py

# 查看波形
python run_post_syn_sim.py --wave

# 生成报告
python run_post_syn_sim.py --report
```

### 方法 2: Makefile

```bash
cd chisel/synthesis

# 完整流程
make full

# 或分步执行
make compile_advanced
make sim_advanced
make wave
make report
```

## 📊 测试内容

### 基本测试平台

1. **系统启动测试**
   - 复位功能
   - 初始状态检查

2. **GPIO 功能测试**
   - 输入输出验证
   - 使能信号检查

3. **中断信号测试**
   - CompactAccel 中断
   - BitNetAccel 中断

4. **稳定性测试**
   - 长时间运行
   - Trap 信号监控

### 高级测试平台

1. **复位功能测试**
   - 长复位序列
   - 复位后状态验证

2. **基本操作测试**
   - 系统运行验证
   - 信号监控

3. **GPIO 模式测试**
   - 多种输入模式
   - 输出响应验证

4. **中断响应测试**
   - 中断触发
   - 响应时间测量

5. **UART 接口测试**
   - 数据发送
   - 接收验证

6. **压力测试**
   - 快速输入变化
   - 稳定性验证

7. **性能分析**
   - 周期统计
   - 中断统计
   - 性能指标

## 🔍 测试结果

### 输出文件

1. **编译日志**: `sim/compile_advanced.log`
   - 编译过程
   - 警告和错误

2. **仿真日志**: `sim/sim_advanced.log`
   - 仿真输出
   - 测试结果

3. **测试报告**: `sim/detailed_report.txt`
   - 详细测试结果
   - 统计信息
   - 结论

4. **波形文件**: `waves/advanced_post_syn.vcd`
   - 信号波形
   - 用于调试

### 报告示例

```
╔════════════════════════════════════════════════════════════╗
║        逻辑综合后网表仿真 - 详细报告                      ║
╚════════════════════════════════════════════════════════════╝

1. 设计信息
   ----------------------------------------
   设计名称: SimpleEdgeAiSoC
   时钟频率: 100 MHz
   仿真时间: 15000 ns
   总周期数: 1500

2. 测试结果
   ----------------------------------------
   ✓ 复位功能测试
   ✓ 基本操作测试
   ✓ GPIO 模式测试
   ✓ 中断响应测试
   ✓ UART 接口测试
   ✓ 压力测试

3. 统计信息
   ----------------------------------------
   Trap 次数: 0
   CompactAccel 中断: 5
   BitNetAccel 中断: 3

4. 结论
   ----------------------------------------
   综合后网表功能验证通过
   所有测试用例执行成功
   系统运行稳定
```

## 🛠️ 支持的工具

### VCS (Synopsys)

**优点:**
- 业界标准
- 性能优秀
- 功能完整

**使用:**
```bash
make compile_advanced
make sim_advanced
```

### Verilator (开源)

**优点:**
- 免费开源
- 速度快
- 易于安装

**使用:**
```bash
python run_post_syn_sim.py --simulator verilator
```

### ModelSim/QuestaSim

**优点:**
- 广泛使用
- 调试功能强
- 支持混合仿真

**使用:**
需要修改 Makefile 添加 ModelSim 支持

## 📈 性能指标

仿真会统计：

- **仿真时间**: 总仿真时间（ns）
- **时钟周期**: 总时钟周期数
- **中断次数**: 各类中断的触发次数
- **Trap 次数**: 异常发生次数
- **测试覆盖**: 测试用例覆盖率

## ⚠️ 注意事项

### 1. 网表准备

在运行仿真前，需要：
1. 运行逻辑综合生成网表
2. 将网表放在 `synthesis/netlist/` 目录
3. 确保网表文件名为 `SimpleEdgeAiSoC_syn.v`

### 2. 标准单元库

如果使用特定工艺库：
1. 在 `filelist.f` 中添加库文件路径
2. 确保库文件可访问
3. 检查库版本兼容性

### 3. 仿真时间

综合后网表仿真比 RTL 仿真慢：
- RTL 仿真: 快速，适合功能验证
- 门级仿真: 较慢，包含时序信息
- 建议: 先用 RTL 验证功能，再用门级验证时序

### 4. 时序问题

如果发现时序问题：
1. 检查综合约束
2. 调整时钟频率
3. 优化关键路径
4. 重新综合

## 🔧 自定义和扩展

### 添加新测试

1. 编辑 `testbench/advanced_post_syn_tb.sv`
2. 添加新的 task
3. 在主测试序列中调用

### 修改测试参数

```systemverilog
// 在测试平台中修改
parameter CLK_PERIOD = 10;  // 时钟周期
parameter TEST_CYCLES = 1000;  // 测试周期数
```

### 添加新的监控信号

```systemverilog
// 在测试平台中添加
always @(posedge clk) begin
  if (custom_signal) begin
    $display("[%0t] 自定义信号触发", $time);
  end
end
```

## 📚 与 RTL 仿真的对比

| 特性 | RTL 仿真 | 门级仿真 |
|------|---------|---------|
| 速度 | 快 | 慢 |
| 精度 | 功能级 | 门级 + 时序 |
| 用途 | 功能验证 | 时序验证 |
| 时机 | 开发阶段 | 综合后 |
| 工具 | Chisel/Verilator | VCS/ModelSim |

## 🎓 最佳实践

### 1. 分阶段验证

```
RTL 仿真 → 综合 → 门级仿真 → 布局布线 → 后仿真
```

### 2. 测试用例复用

- 使用相同的测试向量
- 比较 RTL 和门级结果
- 确保功能一致性

### 3. 覆盖率分析

- 代码覆盖率
- 功能覆盖率
- 断言覆盖率

### 4. 自动化

- 使用脚本自动运行
- 自动比较结果
- 生成测试报告

## 📞 故障排除

### 问题 1: 网表文件不存在

**解决:**
```bash
# 检查网表文件
ls -l synthesis/netlist/

# 如果不存在，需要先运行综合
# 使用 Design Compiler 或 Genus
```

### 问题 2: 编译错误

**解决:**
```bash
# 查看编译日志
cat synthesis/sim/compile_advanced.log

# 检查文件列表
cat synthesis/testbench/filelist.f

# 确保所有文件存在
```

### 问题 3: 仿真超时

**解决:**
```systemverilog
// 在测试平台中增加超时时间
initial begin
  #200000000;  // 增加到 200ms
  $display("错误: 仿真超时!");
  $finish;
end
```

### 问题 4: 功能不匹配

**解决:**
1. 比较 RTL 和门级仿真结果
2. 检查综合约束
3. 查看综合报告
4. 检查时序违例

## 🎯 流片前检查清单

- [ ] RTL 仿真通过
- [ ] 逻辑综合完成
- [ ] 门级仿真通过
- [ ] 功能一致性验证
- [ ] 时序约束满足
- [ ] 测试覆盖率 > 95%
- [ ] 所有测试用例通过
- [ ] 测试报告生成
- [ ] 波形文件保存
- [ ] 问题记录和解决

## 📖 相关文档

- `chisel/synthesis/README.md` - 详细使用说明
- `docs/RISC-V_AI加速器芯片流片说明报告.md` - 流片报告
- `docs/开源芯片流片说明报告.md` - 流片模板

## 🎉 总结

逻辑综合后网表仿真是流片前的关键步骤：

1. ✅ 已创建完整的测试平台
2. ✅ 支持多种仿真工具
3. ✅ 提供自动化脚本
4. ✅ 生成详细测试报告
5. ✅ 包含完整文档

**立即开始:**
```bash
cd chisel/synthesis
python run_post_syn_sim.py
```

---

**问题？** 查看 `chisel/synthesis/README.md`  
**需要帮助？** 运行 `make help` 或 `python run_post_syn_sim.py --help`

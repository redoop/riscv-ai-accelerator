# Web 波形查看器使用指南

## 简介

这是一个基于 Web 的 VCD 波形查看器，可以在浏览器中查看仿真波形，无需安装 GTKWave 或 Verdi 等传统工具。

## 特性

- 🌐 **Web 界面** - 在浏览器中查看波形，支持远程访问
- 🔍 **信号搜索** - 快速查找和过滤信号
- 📊 **交互式显示** - 支持缩放、滚动查看波形
- 🎨 **现代 UI** - 深色主题，类似 VS Code 风格
- 📈 **多信号支持** - 同时显示多个信号波形
- 🚀 **轻量级** - 纯 Python + HTML/JavaScript，无需复杂依赖

## 安装依赖

```bash
# 安装 Flask
python3 -m pip install flask --user
```

## 启动服务器

### 方法 1: 使用启动脚本（推荐）

```bash
cd chisel/synthesis
./start_wave_viewer.sh
```

### 方法 2: 直接运行 Python 脚本

```bash
cd chisel/synthesis
python3 wave_viewer.py --port 5000 --host 0.0.0.0
```

### 命令行参数

- `--port`: Web 服务器端口（默认: 5000）
- `--host`: 服务器地址（默认: 0.0.0.0，允许远程访问）
- `--wave-dir`: 波形文件目录（默认: waves）

## 访问界面

启动服务器后，在浏览器中访问：

- **本地访问**: http://localhost:5000
- **远程访问**: http://服务器IP:5000

例如，如果服务器 IP 是 192.168.0.103：
- http://192.168.0.103:5000

## 使用步骤

1. **启动服务器**
   ```bash
   ./start_wave_viewer.sh
   ```

2. **打开浏览器**
   - 访问 http://localhost:5000

3. **加载波形文件**
   - 在顶部下拉菜单中选择 VCD 文件
   - 点击"加载"按钮

4. **选择信号**
   - 在左侧信号列表中勾选要查看的信号
   - 使用搜索框快速查找信号

5. **查看波形**
   - 波形会自动显示在右侧画布上
   - 使用"放大"/"缩小"按钮调整显示比例
   - 使用"适应"按钮自动调整到窗口大小

## 功能说明

### 信号类型显示

- **单比特信号**: 显示为数字波形（高/低电平）
- **多比特信号**: 显示为总线波形，带十六进制值标注

### 缩放控制

- **放大**: 增加时间轴分辨率，查看更多细节
- **缩小**: 减少时间轴分辨率，查看更长时间范围
- **适应**: 自动调整到窗口大小

### 搜索功能

在搜索框中输入关键字，可以快速过滤信号列表：
- 支持信号名称搜索
- 支持层次路径搜索
- 实时过滤显示

## 集成到仿真流程

可以在 `run_post_syn_sim.py` 中添加 Web 查看选项：

```bash
# 运行仿真
python run_post_syn_sim.py --simulator iverilog --netlist ics55

# 启动 Web 波形查看器
./start_wave_viewer.sh
```

或者在浏览器中直接访问已运行的服务器。

## 性能优化

针对大型 VCD 文件（>50MB）进行了专门优化：

### 智能抽样技术

1. **快速加载模式**
   - 首次加载只解析文件头部和时间范围（~12秒 for 332MB 文件）
   - 不预加载所有信号数据，节省内存

2. **按需加载**
   - 只加载用户选择的信号
   - 支持时间范围过滤
   - 根据缩放级别动态调整采样率

3. **智能压缩**
   - 保留所有信号值变化点（边沿检测）
   - 移除冗余的中间采样点
   - 自动合并连续相同值
   - 压缩比可达 1:25000

4. **自适应采样**
   - 根据时间范围自动调整采样密度
   - 放大时自动加载更高分辨率数据
   - 缩小时使用更低分辨率数据

### 性能指标（332MB VCD 文件测试）

- **文件加载**: 11.76秒（只加载元数据）
- **信号数量**: 344,614 个
- **单信号加载**: ~6秒（全时间范围）
- **数据压缩**: 从数百万点压缩到 ~500 点/信号
- **内存占用**: 按需加载，显著降低内存使用

### 使用建议

- **小文件（<50MB）**: 直接加载，无需特殊处理
- **中等文件（50-500MB）**: 自动启用智能抽样
- **大文件（>500MB）**: 建议先选择少量关键信号查看

## 故障排除

### 问题 1: Flask 未安装

```bash
python3 -m pip install flask --user
```

### 问题 2: 端口被占用

更改端口号：
```bash
python3 wave_viewer.py --port 8080
```

### 问题 3: 无法远程访问

确保防火墙允许访问端口：
```bash
# Ubuntu/Debian
sudo ufw allow 5000

# CentOS/RHEL
sudo firewall-cmd --add-port=5000/tcp --permanent
sudo firewall-cmd --reload
```

### 问题 4: 波形文件未找到

确保 VCD 文件在 `waves/` 目录下：
```bash
ls -lh waves/*.vcd
```

## 技术架构

- **后端**: Python + Flask
- **前端**: HTML5 + Canvas + JavaScript
- **VCD 解析**: 自定义 Python 解析器
- **可视化**: HTML5 Canvas 绘图

## 限制

- 当前版本主要支持基本的 VCD 格式
- 超大文件（>1GB）可能需要较长加载时间
- 不支持 FST、FSDB 等其他波形格式（仅支持 VCD）

## 未来改进

- [ ] 支持更多波形格式（FST、FSDB）
- [ ] 添加信号值光标显示
- [ ] 支持信号分组
- [ ] 添加测量工具（时间差、频率等）
- [ ] 支持波形导出为图片
- [ ] 添加信号比较功能

## 示例

```bash
# 完整工作流程示例

# 1. 运行仿真生成 VCD
cd chisel/synthesis
python run_post_syn_sim.py --simulator iverilog --netlist ics55

# 2. 启动 Web 波形查看器
./start_wave_viewer.sh

# 3. 在浏览器中打开
# http://localhost:5000

# 4. 选择 post_syn.vcd 文件并加载

# 5. 选择感兴趣的信号查看波形
```

## 许可证

与项目主体相同的许可证。

## 贡献

欢迎提交问题和改进建议！

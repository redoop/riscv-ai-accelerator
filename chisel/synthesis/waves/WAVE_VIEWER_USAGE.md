# Web 波形查看器使用指南

## 快速开始

### 1. 启动服务器

```bash
cd chisel/synthesis
./start_wave_viewer.sh
```

或者：

```bash
python3 wave_viewer.py --port 5000
```

### 2. 打开浏览器

访问 http://localhost:5000

### 3. 加载波形文件

1. 在顶部下拉菜单选择 VCD 文件（例如 `post_syn.vcd`）
2. 点击"加载"按钮
3. 等待文件加载完成（大文件约 10-15 秒）

### 4. 选择信号

1. 在左侧信号列表中勾选要查看的信号
2. 可以使用搜索框快速查找信号
3. 建议首次选择 5-10 个信号

### 5. 查看波形

点击"查看波形"按钮，系统会自动渲染波形

## 流式加载模式详细说明

### 工作原理

流式加载模式将波形分成多个小块（tiles），每块包含 5 个信号：

```
┌─────────────────────────────────┐
│ Tile 0: 信号 1-5                │  ← 可见，已加载
├─────────────────────────────────┤
│ Tile 1: 信号 6-10               │  ← 可见，已加载
├─────────────────────────────────┤
│ Tile 2: 信号 11-15              │  ← 即将可见，预加载
├─────────────────────────────────┤
│ Tile 3: 信号 16-20              │  ← 不可见，未加载
└─────────────────────────────────┘
```

### 使用技巧

1. **滚动查看**
   - 向下滚动查看更多信号
   - 系统会自动加载新的波形块
   - 已加载的块会保持在内存中

2. **性能优化**
   - 首次加载只渲染可见区域（约 2-3 个块）
   - 滚动时提前加载上下各一个块
   - 避免同时选择过多信号（建议 <50 个）

3. **缩放功能**
   - 放大：查看更多细节
   - 缩小：查看更长时间范围
   - 适应：自动调整到窗口大小

### 加载状态

右上角显示加载进度：

```
已加载: 3/10 块 | 信号: 25 个
```

- **已加载**: 已经渲染的波形块数量
- **总块数**: 所有信号需要的总块数
- **信号数**: 当前选中的信号总数

## 常见使用场景

### 场景 1: 查看 CPU 核心信号

```
1. 搜索 "cpu" 或 "riscv"
2. 选择关键信号：
   - clock
   - reset
   - mem_valid
   - mem_ready
   - trap
3. 点击"查看波形"
4. 观察信号时序关系
```

### 场景 2: 调试 GPIO 接口

```
1. 搜索 "gpio"
2. 选择：
   - gpio_in[31:0]
   - gpio_out[31:0]
   - gpio_oe[31:0]
3. 查看波形
4. 使用缩放功能查看特定时间段
```

### 场景 3: 分析总线事务

```
1. 搜索 "mem" 或 "bus"
2. 选择总线信号：
   - mem_addr
   - mem_wdata
   - mem_rdata
   - mem_wstrb
   - mem_valid
   - mem_ready
3. 查看波形
4. 观察读写时序
```

## 性能对比

### 332MB VCD 文件测试结果

| 操作 | Canvas 模式 | 图片模式 | 流式模式 |
|-----|-----------|---------|---------|
| 文件加载 | 60+ 秒 | 12 秒 | 12 秒 |
| 首次显示 | 无法完成 | 30 秒 | 3 秒 |
| 滚动流畅度 | N/A | N/A | 流畅 |
| 内存占用 | >2GB | ~500MB | ~100MB |
| 支持信号数 | <10 | <20 | 无限制 |

### 结论

- **小文件（<50MB）**: 三种模式都可以
- **中等文件（50-200MB）**: 推荐图片或流式模式
- **大文件（>200MB）**: 必须使用流式模式

## 故障排除

### 问题 1: 波形块加载失败

**症状**: 显示"加载失败"

**解决方案**:
1. 检查网络连接
2. 刷新页面重试
3. 减少同时选择的信号数量

### 问题 2: 滚动时卡顿

**症状**: 滚动不流畅

**解决方案**:
1. 减少选择的信号数量
2. 关闭其他占用资源的标签页
3. 使用更快的浏览器（推荐 Chrome）

### 问题 3: 波形显示不完整

**症状**: 部分信号没有显示

**解决方案**:
1. 向下滚动，等待加载
2. 点击"查看波形"重新加载
3. 检查信号是否有数据

### 问题 4: 服务器响应慢

**症状**: 加载时间过长

**解决方案**:
1. 检查 VCD 文件大小
2. 减少 max_points 参数（修改代码）
3. 使用更快的存储设备（SSD）

## 高级功能

### 自定义时间范围（图片模式）

在图片模式下可以指定时间范围：

1. 输入起始时间
2. 输入结束时间
3. 点击"渲染波形"

### 导出波形图片

1. 在图片模式下渲染波形
2. 右键点击波形图
3. 选择"图片另存为"

### 批量选择信号

使用搜索功能快速选择一组信号：

1. 搜索关键字（如 "mem"）
2. 逐个勾选相关信号
3. 或者使用浏览器的多选功能

## 键盘快捷键（计划中）

未来版本将支持：

- `Space`: 暂停/继续自动滚动
- `+/-`: 缩放
- `Home/End`: 跳转到开始/结束
- `Ctrl+F`: 搜索信号

## 技术限制

### 当前限制

1. **单次渲染信号数**: 建议 <50 个
2. **VCD 文件格式**: 仅支持标准 VCD
3. **浏览器兼容性**: 需要现代浏览器（Chrome/Firefox/Edge）
4. **并发用户**: 单用户使用（开发服务器）

### 未来改进

- [ ] 支持 FST/FSDB 格式
- [ ] 添加信号值光标
- [ ] 支持信号分组
- [ ] 添加测量工具
- [ ] 支持多用户并发

## 最佳实践

1. **首次使用**: 先选择少量信号（5-10 个）测试
2. **大文件**: 使用流式加载模式
3. **导出**: 使用图片模式生成高质量图片
4. **调试**: 使用搜索功能快速定位信号
5. **性能**: 关闭不需要的浏览器标签页

## 反馈和支持

如有问题或建议，请：

1. 查看日志输出
2. 检查浏览器控制台
3. 提交 Issue 或联系开发者
